{"id":"aw-018","title":"Leaving field on ChatSendMessageRequest is dead wire","description":"Grace confirmed: POST /sessions/{id}/messages hardcodes sender_leaving=false server-side (chat.py:829). Only POST /v1/chat/sessions (ChatCreateSession) honors the leaving field. Our send-and-leave verb works because it uses ChatCreateSession, but the Leaving field we added to ChatSendMessageRequest in Phase A does nothing. Either remove it from the client type or ask grace to add server support.","status":"closed","priority":3,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-08T08:50:35Z","created_by":"Juan Reyero","updated_at":"2026-02-08T09:50:08Z","closed_at":"2026-02-08T09:50:08Z","close_reason":"Removed dead Leaving field from ChatSendMessageRequest and NetworkChatSendMessageRequest. Server only honors leaving on session creation. All tests pass."}
{"id":"aw-061","title":"Replace fragile mockHandler prefix matching in chat tests","description":"The mockHandler in chat_test.go uses map iteration (undefined order) for prefix matching of parameterized paths. This is fragile — if two handlers share a prefix, behavior is non-deterministic.\n\nSeveral tests already work around this with explicit path guards:\n  if r.URL.Path != \"/v1/chat/sessions\" { http.NotFound(w, r); return }\n\nThis pattern appears in TestOpenFallbackToListSessions, TestFindSessionFallback, TestFindSessionNotFound, TestFindSessionPrefersSmallestFallback, TestListenNoSession.\n\nFix: Replace prefix matching with proper path routing. Options:\n- Use http.ServeMux (Go 1.22+ supports method+path patterns)\n- Use exact matching only, register parameterized paths explicitly per test\n- Use a simple trie or ordered slice instead of a map\n\nFiles: chat/chat_test.go","status":"closed","priority":3,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-08T09:25:16Z","created_by":"Juan Reyero","updated_at":"2026-02-08T09:47:17Z","closed_at":"2026-02-08T09:47:17Z","close_reason":"Removed prefix matching from mockHandler, using exact method+path matching only. Removed 5 path-checking workarounds. All 37 tests pass."}
{"id":"aw-0np","title":"Network chat send-and-wait doesn't wait (no SSE streaming)","description":"The network path for send-and-wait (org/alias addresses) calls NetworkCreateChat and returns immediately without opening an SSE stream. The server returns sse_url in the response but the client never connects to it. This means cross-org send-and-wait is actually fire-and-forget, violating the protocol rule: always wait unless the interlocutor left. The fix is to connect to the returned sse_url and wait for a reply, same as the OSS path does via chat.Send(). This would also fix the output schema inconsistency (network returns NetworkChatCreateResponse, OSS returns SendResult).","notes":"Ivy confirmed (aweb-cloud): SSE streaming works for network chat via /api/v1/network/chat/{session_id}/stream (cloud endpoint). The sse_url in NetworkChatCreateResponse already points there. Client needs same auth + deadline query param. Fix: after NetworkCreateChat(), open SSE stream at server_url+sse_url and wait, same as OSS path.","status":"closed","priority":2,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-08T08:37:52Z","created_by":"Juan Reyero","updated_at":"2026-02-08T08:57:02Z","closed_at":"2026-02-08T08:57:02Z","close_reason":"SendNetwork() added with full SSE streaming. Both OSS and network paths share sendCommon() waiting logic. Output schema unified to SendResult. All tests pass."}
{"id":"aw-1qo","title":"Implement aw init cloud bootstrap fallback","description":"Update aw init to support hosted aweb-cloud where /v1/init is unavailable by falling back to authenticated cloud bootstrap endpoint.","design":"Keep OSS /v1/init as primary path. On 403/404 from init, call cloud /api/v1/agents/bootstrap using --cloud-token or AWEB_CLOUD_TOKEN, normalize /api base URLs, and preserve existing init output/config contract.","acceptance_criteria":"1) OSS init behavior unchanged. 2) Cloud fallback issues API key via /api/v1/agents/bootstrap. 3) Works when base URL includes /api. 4) Tests cover fallback success and missing-token failure.","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-06T13:02:38Z","created_by":"Juan Reyero","updated_at":"2026-02-06T13:02:49Z","closed_at":"2026-02-06T13:02:49Z","close_reason":"Closed"}
{"id":"aw-22o","title":"Handle EMAIL_VERIFICATION_REQUIRED 403 in CLI","description":"When any CLI command gets a 403 with error.code=EMAIL_VERIFICATION_REQUIRED, print friendly message with masked_email from details and suggest running aw verify. Currently all 403s show generic error.","status":"closed","priority":1,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-19T13:06:06Z","created_by":"Juan Reyero","updated_at":"2026-02-19T13:41:29Z","closed_at":"2026-02-19T13:41:29Z","close_reason":"Implemented checkVerificationRequired() in helpers.go. fatal() now intercepts EMAIL_VERIFICATION_REQUIRED 403 and shows user-friendly hint with masked email and aw verify instructions. Table-driven integration test covers both with/without masked email branches.","dependencies":[{"issue_id":"aw-22o","depends_on_id":"aw-c32","type":"blocks","created_at":"2026-02-19T13:06:48Z","created_by":"Juan Reyero","metadata":"{}"}]}
{"id":"aw-2yx","title":"Listen returns misleading Status 'sent' on timeout","description":"Listen returns SendResult with Status='sent' on timeout, but nothing was sent. The comment acknowledges this: 'Returns *SendResult for compatibility with existing formatting code.'\n\nThe semantic mismatch can confuse consumers. Consider:\n- Adding a ListenResult type (or using a more generic name like ChatResult)\n- Or at minimum, using Status='timeout' instead of 'sent' for Listen timeouts\n\nThis is low priority since it's an internal API used by cmd/aw/chat.go, but it will cause confusion if other consumers use the chat package.\n\nFiles: chat/chat.go (Listen), chat/types.go","status":"closed","priority":4,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-08T09:25:21Z","created_by":"Juan Reyero","updated_at":"2026-02-08T09:41:03Z","closed_at":"2026-02-08T09:41:03Z","close_reason":"waitForMessage returns 'timeout', sendCommon maps to 'sent' for backward compat. All 37 tests pass.","dependencies":[{"issue_id":"aw-2yx","depends_on_id":"aw-w7a","type":"blocks","created_at":"2026-02-18T16:59:14Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"aw-344","title":"Add 'aw mail ack' CLI command","description":"AckMessage() client method exists but no CLI command exposes it. Add 'aw mail ack' subcommand that calls POST /v1/messages/{message_id}/ack. Takes --message-id flag.","status":"closed","priority":2,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-04T11:23:06Z","created_by":"Juan Reyero","updated_at":"2026-02-04T11:33:26Z","closed_at":"2026-02-04T11:33:26Z","close_reason":"Closed"}
{"id":"aw-349","title":"Add post-register verification code prompt","description":"After successful aw register, prompt user to enter 6-digit verification code from email. TTY-aware: skip prompt in non-interactive mode, just print instructions. Call POST /api/v1/verify-code with email+code.","status":"closed","priority":1,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-19T13:05:52Z","created_by":"Juan Reyero","updated_at":"2026-02-19T13:31:56Z","closed_at":"2026-02-19T13:31:56Z","close_reason":"Post-register verification prompt implemented, TTY-aware, with test","dependencies":[{"issue_id":"aw-349","depends_on_id":"aw-awb","type":"blocks","created_at":"2026-02-19T13:06:43Z","created_by":"Juan Reyero","metadata":"{}"},{"issue_id":"aw-349","depends_on_id":"aw-vin","type":"blocks","created_at":"2026-02-19T13:06:41Z","created_by":"Juan Reyero","metadata":"{}"}]}
{"id":"aw-43q","title":"Replace chat send with send-and-wait / send-and-leave verbs","description":"## Problem\n\nAgents get trapped in 120s waits because the default chat send behavior is ambiguous. When replying to a message, agents forget --leave-conversation and silently wait for a counter-reply that never comes.\n\n## Solution\n\nReplace the ambiguous chat send with two explicit verbs:\n\n- chat send-and-wait \u003calias\u003e \u003cmsg\u003e — send and wait for reply (120s default)\n  - --start-conversation: 5 min wait (initiating new exchange)\n  - --wait N: custom wait duration\n- chat send-and-leave \u003calias\u003e \u003cmsg\u003e — send with leaving=true, exit immediately\n\nRemove bare chat send entirely. Every send must declare intent.\n\n## Files to update\n\n### aw repo (this repo)\n- cmd/aw/chat.go: replace chatSendCmd with two new commands\n- cmd/aw/aw_test.go: update any chat send tests\n- README.md: update CLI docs\n- skills/aweb/SKILL.md: update command list\n- skills/aweb/resources/COORDINATION_PATTERNS.md: update examples\n\n### bdh repo (alice-coordinator)\n- internal/commands/chat.go: replace send subcommand with two verbs\n- internal/commands/chat_test.go: update tests\n- internal/commands/agent_docs.go: update help templates\n- README.md\n\n### beadhub repo (alice-coordinator)\n- src/beadhub/defaults/invariants/03-communication-chat.md: update subcommand table and examples\n- src/beadhub/defaults/roles/backend.md, frontend.md: update examples\n\n### aweb-cloud repo (ivy-implementer)\n- .release-deps/beadhub/: will get updated on next beadhub release\n\n### beadhub-sot\n- archive/beadhub-chat-spec.md: update CLI section","status":"closed","priority":1,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-07T23:38:53Z","created_by":"Juan Reyero","updated_at":"2026-02-07T23:43:49Z","closed_at":"2026-02-07T23:43:49Z","close_reason":"Implemented send-and-wait/send-and-leave CLI verbs, updated all docs and tests, notified all stakeholders. Branch feat/chat-send-and-wait-leave pushed."}
{"id":"aw-67s","title":"Harden aw init cloud mode token resolution and URL normalization","description":"Improve aw init cloud path by adding strict cloud mode, resilient cloud token selection across server-key/host mismatches, and /api/v1 normalization for cloud bootstrap.","design":"Add --cloud mode to skip /v1/init probing, broaden credential lookup order to include configured accounts by server key and URL host, and normalize cloud root URL for /api and /api/v1 suffixes. Add integration tests for each case.","acceptance_criteria":"1) --cloud mode never probes /v1/init. 2) Configured cloud token is found even when server key and URL host differ. 3) /api/v1 URLs bootstrap correctly. 4) Tests cover all scenarios.","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-06T14:29:13Z","created_by":"Juan Reyero","updated_at":"2026-02-06T14:29:31Z","closed_at":"2026-02-06T14:29:31Z","close_reason":"Closed"}
{"id":"aw-68m","title":"Migrate aw CLI from stdlib flag to cobra","status":"closed","priority":2,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-04T13:51:53Z","created_by":"Juan Reyero","updated_at":"2026-02-04T17:04:37Z","closed_at":"2026-02-04T17:04:37Z","close_reason":"Migrated from stdlib flag to spf13/cobra; flags now work in any position"}
{"id":"aw-6ep","title":"Fix Listen to not accept replayed historical messages","description":"Listen uses an acceptAll acceptor that grabs the first SSE event it sees. Since the SSE stream replays historical messages, Listen immediately returns the oldest message in the conversation instead of waiting for new ones.\n\nFix: Once the server supports the 'after' parameter, Listen passes no 'after' value so the server skips replay entirely. Listen then only receives genuinely new messages.\n\nInterim workaround (if needed before server change): snapshot the latest message ID via ChatHistory(limit=1) before opening SSE, use an acceptor that skips until past that ID.","status":"closed","priority":2,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-08T11:52:04Z","created_by":"Juan Reyero","updated_at":"2026-02-08T12:18:11Z","closed_at":"2026-02-08T12:18:11Z","close_reason":"Implemented in commit c40f1b8: ChatStream/NetworkChatStream accept after param, Send passes sentAt timestamp, Listen passes nil, skipped replay events filtered from result.Events","dependencies":[{"issue_id":"aw-6ep","depends_on_id":"aw-sb5","type":"blocks","created_at":"2026-02-18T16:59:14Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"aw-6k7","title":"@handle human DM addressing","description":"Check for @ prefix in mail send to route to POST /v1/network/dm endpoint. New dm.go library file with SendDM client method.","status":"closed","priority":2,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-21T11:54:24Z","created_by":"Juan Reyero","updated_at":"2026-02-21T12:01:49Z","closed_at":"2026-02-21T12:01:49Z","close_reason":"Added @handle DM routing in mail send with SendDM client method"}
{"id":"aw-6si","title":"Handle USERNAME_TAKEN and ALIAS_TAKEN 409 errors in aw register","description":"Parse structured 409 errors from server. USERNAME_TAKEN includes attempted_username and source (email_derived or explicit). ALIAS_TAKEN includes attempted alias. Print clear messages so the calling agent/human knows to retry with different values.","status":"closed","priority":1,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-19T13:05:38Z","created_by":"Juan Reyero","updated_at":"2026-02-19T13:21:55Z","closed_at":"2026-02-19T13:21:55Z","close_reason":"Structured 409 parsing for USERNAME_TAKEN and ALIAS_TAKEN with clear CLI messages","dependencies":[{"issue_id":"aw-6si","depends_on_id":"aw-awb","type":"blocks","created_at":"2026-02-19T13:06:38Z","created_by":"Juan Reyero","metadata":"{}"}]}
{"id":"aw-7dv","title":"aw block/unblock commands","description":"New block.go library with Block/Unblock/ListBlocked client methods. New cmd/aw/block.go with aw block, aw block list, aw unblock cobra commands.","status":"closed","priority":2,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-21T11:54:28Z","created_by":"Juan Reyero","updated_at":"2026-02-21T12:07:17Z","closed_at":"2026-02-21T12:07:17Z","close_reason":"Added block/unblock commands with review fixes (JSON unblock output, stronger agent-level test assertions)"}
{"id":"aw-7l4","title":"Add 'aw lock renew' CLI command","description":"ReservationRenew() client method exists but no CLI command exposes it. Add 'aw lock renew' subcommand that calls POST /v1/reservations/renew. Takes --resource-key and optional --ttl-seconds flags.","status":"closed","priority":2,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-04T11:23:07Z","created_by":"Juan Reyero","updated_at":"2026-02-04T11:33:26Z","closed_at":"2026-02-04T11:33:26Z","close_reason":"Closed"}
{"id":"aw-7xi","title":"aw init --namespace flag","description":"Add --namespace flag to aw init that forces cloud mode and passes namespace_slug to cloud bootstrap. Requires --alias.","status":"closed","priority":2,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-21T11:54:33Z","created_by":"Juan Reyero","updated_at":"2026-02-21T12:13:31Z","closed_at":"2026-02-21T12:13:31Z","close_reason":"Added --namespace flag with cloud mode forcing, alias requirement, and namespace propagation","dependencies":[{"issue_id":"aw-7xi","depends_on_id":"aw-ejt","type":"blocks","created_at":"2026-02-21T11:54:40Z","created_by":"Juan Reyero","metadata":"{}"}]}
{"id":"aw-8gi","title":"Fix inconsistent CLI error messages for missing flags","description":"runLockAcquire and runLockRelease say 'Missing required flags' (generic plural) while runLockRenew and runMailAck say 'Missing required flag: --flag-name' (specific). Standardize all missing-flag errors to name the specific missing flag.","status":"closed","priority":3,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-04T12:25:11Z","created_by":"Juan Reyero","updated_at":"2026-02-06T18:13:40Z","closed_at":"2026-02-06T18:13:40Z","close_reason":"Standardized missing-flag errors and added --debug/AW_DEBUG for background error visibility"}
{"id":"aw-awb","title":"Make --username and --alias required on aw register","description":"Remove auto-allocation. Both flags required. Username is user identity, alias is agent public address. No defaulting from email, no name pool.","status":"closed","priority":1,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-19T13:05:30Z","created_by":"Juan Reyero","updated_at":"2026-02-19T13:14:07Z","closed_at":"2026-02-19T13:14:07Z","close_reason":"--username and --alias now required on aw register, with tests"}
{"id":"aw-c32","title":"Add aw verify command","description":"New CLI command: aw verify. Calls POST /api/v1/verify-code with email+code. Resolves email from Account config via .aw/context. Prompts for 6-digit code interactively. Fires heartbeat after successful verification to confirm key works.","status":"closed","priority":1,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-19T13:05:59Z","created_by":"Juan Reyero","updated_at":"2026-02-19T13:28:44Z","closed_at":"2026-02-19T13:28:44Z","close_reason":"aw verify command implemented with config resolution, error parsing, code review fixes applied","dependencies":[{"issue_id":"aw-c32","depends_on_id":"aw-vin","type":"blocks","created_at":"2026-02-19T13:06:46Z","created_by":"Juan Reyero","metadata":"{}"}]}
{"id":"aw-ckv","title":"Pass sent message timestamp as after in sendCommon SSE connect","description":"sendCommon opens SSE to wait for replies. Currently the SSE stream replays up to 50 historical messages and the acceptor skips past the sent message ID. This wastes bandwidth and latency.\n\nFix: Pass the sent message's timestamp as the 'after' parameter when opening the SSE stream. The server will only replay messages since the send (usually 0-1, catching the send→SSE race window). The sentMessageID skip logic in the acceptor can be simplified or removed since replayed messages before the send won't appear.\n\nDepends on: ChatStream after parameter being added.","status":"closed","priority":2,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-08T11:52:08Z","created_by":"Juan Reyero","updated_at":"2026-02-08T12:18:11Z","closed_at":"2026-02-08T12:18:11Z","close_reason":"Implemented in commit c40f1b8: ChatStream/NetworkChatStream accept after param, Send passes sentAt timestamp, Listen passes nil, skipped replay events filtered from result.Events","dependencies":[{"issue_id":"aw-ckv","depends_on_id":"aw-sb5","type":"blocks","created_at":"2026-02-18T16:59:14Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"aw-cnn","title":"Add 'aw agents' CLI command","description":"ListAgents() client method exists but no CLI command exposes it. Add 'aw agents' command that calls GET /v1/agents and outputs agent list as JSON. Response includes agent_id, alias, human_name, agent_type, status, last_seen, online.","status":"closed","priority":1,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-04T11:23:06Z","created_by":"Juan Reyero","updated_at":"2026-02-04T11:33:26Z","closed_at":"2026-02-04T11:33:26Z","close_reason":"Closed"}
{"id":"aw-e1p","title":"Add --debug flag for heartbeat and background error visibility","description":"fireHeartbeat() silently swallows all errors. Agents may appear offline with no feedback. Add a --debug flag or AW_DEBUG env var that logs background errors (heartbeat failures, config resolution issues) to stderr.","status":"closed","priority":3,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-04T12:25:15Z","created_by":"Juan Reyero","updated_at":"2026-02-06T18:13:40Z","closed_at":"2026-02-06T18:13:40Z","close_reason":"Standardized missing-flag errors and added --debug/AW_DEBUG for background error visibility"}
{"id":"aw-ejt","title":"RegisterResponse namespace field","description":"Add NamespaceSlug to RegisterResponse, Account, Selection, and store it when returned by server","status":"closed","priority":2,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-21T11:54:15Z","created_by":"Juan Reyero","updated_at":"2026-02-21T11:57:34Z","closed_at":"2026-02-21T11:57:34Z","close_reason":"Added NamespaceSlug to RegisterResponse, Account, Selection, and config storage"}
{"id":"aw-fkp","title":"Use server-side timestamp for SSE after parameter to avoid clock skew","description":"The SSE after parameter currently uses a client-side sentAt timestamp. If client and server clocks differ, this could miss messages (client ahead) or over-replay (client behind). The proper fix is for the server to return created_at in the chat send response, so the client uses a server-authoritative timestamp. Not urgent for localhost deployment but needed for remote servers.","status":"closed","priority":3,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-08T12:27:17Z","created_by":"Juan Reyero","updated_at":"2026-02-08T12:29:26Z","closed_at":"2026-02-08T12:29:26Z","close_reason":"YAGNI - hypothetical problem for non-existent remote deployment"}
{"id":"aw-ga3","title":"Add post-verify heartbeat confirmation","description":"After successful aw verify, fire a heartbeat request to confirm the API key actually works. Print 'Verified\\! Your agent is now active.' on success. Surface error if heartbeat fails.","status":"closed","priority":2,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-19T13:06:14Z","created_by":"Juan Reyero","updated_at":"2026-02-19T13:51:06Z","closed_at":"2026-02-19T13:51:06Z","close_reason":"After successful aw verify, fires a heartbeat POST using the API key from config to confirm the agent is active. Prints 'Your agent is now active.' on success, or a warning on failure. Eliminated redundant config loading by capturing API key from existing resolution.","dependencies":[{"issue_id":"aw-ga3","depends_on_id":"aw-c32","type":"blocks","created_at":"2026-02-19T13:06:51Z","created_by":"Juan Reyero","metadata":"{}"}]}
{"id":"aw-grj","title":"Add ReservationRevoke() client method and 'aw lock revoke' CLI command","description":"POST /v1/reservations/revoke endpoint has no Go client method. Add ReservationRevoke() to client library and 'aw lock revoke' CLI command. Request: {prefix (optional)}. Response: {revoked_count, revoked_keys}.","status":"closed","priority":3,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-04T11:23:09Z","created_by":"Juan Reyero","updated_at":"2026-02-04T11:33:26Z","closed_at":"2026-02-04T11:33:26Z","close_reason":"Closed"}
{"id":"aw-gzh","title":"Add npm distribution channel for aw CLI","status":"closed","priority":2,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-11T18:32:47Z","created_by":"Juan Reyero","updated_at":"2026-02-12T11:18:36Z","closed_at":"2026-02-12T11:18:36Z","close_reason":"npm distribution channel working: v0.11.0 published to npmjs.org, all 7 packages live, npx @awebai/aw version verified"}
{"id":"aw-ieg","title":"Add contacts management and access-mode to aw CLI","status":"closed","priority":2,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-08T14:26:20Z","created_by":"Juan Reyero","updated_at":"2026-02-08T14:31:40Z","closed_at":"2026-02-08T14:31:40Z","close_reason":"Contacts CRUD + agent access-mode CLI commands implemented with full test coverage"}
{"id":"aw-j80","title":"Design: explicit send-and-wait / send-and-leave chat protocol","description":"## Problem\n\nAgents coordinating via chat get trapped in 120-second waits. The most common failure: an agent replies to a waiting sender but forgets --leave-conversation, blocking for 120s waiting for a counter-reply that never comes.\n\nThe deeper issue: the protocol doesn't propagate wait state. When you receive a message, you don't know if the sender is sitting there waiting for your response. And when you reply, the default behavior (wait 120s) assumes you're starting a new exchange, not answering one.\n\n## Correct Protocol\n\nThe rule is simple: **always wait after sending, unless the other party left in the previous round.**\n\n### Flow\n\n1. A sends and waits (--start-conversation, 5 min)\n2. B sees the message, sends reply and waits (default 120s)\n3. A gets B's reply. A knows B is waiting (sender_waiting=true in the SSE event). A thinks, writes back, and leaves (--leave-conversation).\n4. B receives A's reply plus the info that A is not waiting (sender_leaving=true). B either replies-and-leaves, or just stops.\n\nThe agent that ends the conversation MUST make it explicit. Otherwise the other agent will, by default, reply and wait — and get trapped.\n\n## What's Missing\n\n### 1. Receiving agent doesn't know if sender is waiting\n\nWhen B receives a message via SSE, the event doesn't include sender_waiting. B can't tell if A is sitting there expecting a reply or if A fired-and-forgot. This should be appended to every message event so the receiving agent always knows.\n\n### 2. Leaving can't be signaled via ChatSendMessage\n\nCurrently leaving can only be signaled via ChatCreateSession (alias-based). ChatSendMessage (session-ID-based) has no Leaving field, so there's no way to leave via the session-ID path. This is inconsistent with HangOn which works on both.\n\n### 3. Default behavior is ambiguous\n\nThe current flags are:\n- --start-conversation: wait 5 min\n- --leave-conversation: send and exit\n- (default): wait 120s\n\nThe problem is the default. \"wait 120s\" is correct for continuing a conversation but wrong for a final reply. Agents must remember to add --leave-conversation, and they forget.\n\nConsider making the intent more explicit, e.g.:\n- send-and-wait: \"I expect a reply, wait for it\"\n- send-and-leave: \"I'm done, don't wait\"\n\nThis removes the ambiguous default and forces every send to declare intent.\n\n## Implementation Phases\n\n### Phase A: Wire protocol gaps (client-only, backward compatible)\n\n1. Add Leaving field to ChatSendMessageRequest and NetworkChatSendMessageRequest (omitempty, server ignores unknown fields)\n2. Add SenderWaiting field to Event struct, parse sender_waiting from SSE events\n3. Add SenderWaiting to ChatSessionItem for when server starts including it\n\n### Phase B: Server-side sender_waiting propagation\n\nWhen B sends a message while waiting on SSE, the message event delivered to A should include sender_waiting: true. This lets A know B expects a reply. Server needs to:\n- Include sender_waiting in SSE message events\n- Include sender_waiting in ChatSessionItem (list sessions response)\n\n### Phase C: UX — make wait intent explicit\n\nEvaluate whether to replace the ambiguous default with explicit send-and-wait / send-and-leave semantics. This is a UX decision that affects how bdh :aweb chat commands work.","status":"closed","priority":2,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-07T22:51:54Z","created_by":"Juan Reyero","updated_at":"2026-02-07T22:54:50Z","closed_at":"2026-02-07T22:54:50Z","close_reason":"Phase A wire protocol gaps implemented: Leaving on ChatSendMessage, SenderWaiting on SSE events, propagation to SendResult. Phases B (server) and C (UX) remain as future work."}
{"id":"aw-ktk","title":"Update usage() help text with new commands","description":"After adding agents, mail ack, lock renew, project, and lock revoke commands, update the usage() function in main.go to include them all.","status":"closed","priority":2,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-04T11:23:15Z","created_by":"Juan Reyero","updated_at":"2026-02-04T11:33:26Z","closed_at":"2026-02-04T11:33:26Z","close_reason":"Closed"}
{"id":"aw-lmj","title":"Fix SSE goroutine leak in chat Send()","description":"In chat/chat.go Send(), streamToChannel() goroutine may leak if context cancels while it's reading from the SSE stream. defer stream.Close() may close the stream while the goroutine is still reading. Need explicit synchronization or errgroup to ensure clean shutdown.","status":"closed","priority":1,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-04T12:25:04Z","created_by":"Juan Reyero","updated_at":"2026-02-06T16:31:44Z","closed_at":"2026-02-06T16:31:44Z","close_reason":"Fixed goroutine leak in streamToChannel: returns cleanup func that closes stream, cancels goroutine, waits for exit. Channel sends use select to avoid blocking on full buffer."}
{"id":"aw-mq5","title":"Fix duplicate hang_on callback firing in sendCommon and Listen","description":"In both sendCommon and Listen, when a hang_on event arrives, the callback fires twice with confusingly different messages:\n\nWhen ExtendsWaitSeconds \u003e 0:\n  1. callback('hang_on', 'bob: thinking...')          — the body\n  2. callback('wait_extended', 'wait extended by 5 min (bob requested more time)')  — from extendWait\n\nWhen ExtendsWaitSeconds == 0:\n  1. callback('hang_on', 'bob: thinking...')          — the body\n  2. callback('hang_on', 'bob requested more time')   — from the else-if branch\n\nThe second callback in the ExtendsWaitSeconds==0 case is redundant — the first callback already conveyed the hang_on with the body.\n\nFix: Remove the else-if branch (lines 399-401 in sendCommon, equivalent in Listen). The first callback('hang_on', body) is sufficient. The wait_extended callback from extendWait is useful and should stay.\n\nFiles: chat/chat.go (two locations — but should become one after issue 1 is fixed)","status":"closed","priority":3,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-08T09:25:02Z","created_by":"Juan Reyero","updated_at":"2026-02-08T09:38:58Z","closed_at":"2026-02-08T09:38:58Z","close_reason":"Removed redundant else-if branch. Added TestHangOnWithoutExtensionFiresOneCallback. All 37 tests pass.","dependencies":[{"issue_id":"aw-mq5","depends_on_id":"aw-w7a","type":"blocks","created_at":"2026-02-18T16:59:14Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"aw-mwx","title":"Split main.go into per-command files","description":"cmd/aw/main.go is 1000+ lines with all CLI command handlers. Split into separate files by command group (e.g. mail.go, chat.go, lock.go, agents.go) for maintainability. Keep main() and usage() in main.go.","status":"closed","priority":3,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-04T12:25:13Z","created_by":"Juan Reyero","updated_at":"2026-02-04T17:04:37Z","closed_at":"2026-02-04T17:04:37Z","close_reason":"Split main.go into per-command files as part of cobra migration"}
{"id":"aw-n5m","title":"Chat operations (Listen/Open/History/HangOn/ShowPending) fail for network addresses","description":"All chat operations except Send go through findSession(), which only queries OSS endpoints (/v1/chat/pending, /v1/chat/sessions). Network conversations live at /api/v1/network/chat/... endpoints.\n\nImpact: 'aw chat listen acme/bot', 'aw chat open acme/bot', 'aw chat history acme/bot', 'aw chat hang-on acme/bot msg', and 'aw chat show-pending acme/bot' all fail with 'no conversation found'.\n\nOnly chatSend in cmd/aw/chat.go:24-31 correctly routes between OSS and network paths. All other operations need equivalent routing.\n\nFix approach:\n1. findSession needs a network-aware variant (or a flag/separate function) that queries NetworkChatPending and network session list endpoints\n2. Listen needs a network variant (like SendNetwork is to Send) that uses client.NetworkChatStream instead of client.ChatStream\n3. Open, History, HangOn, ShowPending need network routing at the cmd/aw/chat.go level (like chatSend does with ParseNetworkAddress)\n4. The underlying network client methods for pending/history/mark-read already exist in network.go\n\nFiles: chat/chat.go, cmd/aw/chat.go, network.go","status":"closed","priority":2,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-08T09:24:56Z","created_by":"Juan Reyero","updated_at":"2026-02-08T09:59:15Z","closed_at":"2026-02-08T09:59:15Z","close_reason":"All chat operations now route through network endpoints for org/alias addresses. Added NetworkChatHistory client method, findNetworkSession, 5 network variant protocol functions, and routing helpers at cmd level. All 42 tests pass."}
{"id":"aw-nv6","title":"Make worktree context file writes atomic","description":"awconfig/context.go SaveWorktreeContextTo() uses os.WriteFile directly, unlike global config which uses temp-file-and-rename. Process kill during write could corrupt the context file. Should use the same atomic write pattern as global_config.go.","status":"closed","priority":2,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-04T12:25:08Z","created_by":"Juan Reyero","updated_at":"2026-02-06T18:02:05Z","closed_at":"2026-02-06T18:02:05Z","close_reason":"Extracted atomicWriteFile() helper with chmod-before-write pattern. Both SaveGlobalTo and SaveWorktreeContextTo now use it."}
{"id":"aw-ol8","title":"aw agent privacy command","description":"Add privacy field to AgentView/PatchAgentRequest/PatchAgentResponse with omitempty on access_mode. New agent privacy subcommand.","status":"closed","priority":2,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-21T11:54:19Z","created_by":"Juan Reyero","updated_at":"2026-02-21T11:59:40Z","closed_at":"2026-02-21T11:59:40Z","close_reason":"Added agent privacy command with GET/SET, omitempty on access_mode"}
{"id":"aw-oo0","title":"Fix config temp file permissions window","description":"In awconfig/global_config.go, os.CreateTemp uses default umask before API key data is written. There's a brief window where the temp file may have overly permissive mode. Should explicitly chmod the temp file before writing sensitive data, or use os.OpenFile with restrictive mode.","status":"closed","priority":2,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-04T12:25:06Z","created_by":"Juan Reyero","updated_at":"2026-02-06T18:02:05Z","closed_at":"2026-02-06T18:02:05Z","close_reason":"Extracted atomicWriteFile() helper with chmod-before-write pattern. Both SaveGlobalTo and SaveWorktreeContextTo now use it."}
{"id":"aw-p1b","title":"Refactor chat CLI: positional args and rename --leaving","description":"Per alignment with Alice (bdh-2et): (1) Change chat subcommands to use positional args for required params (alias, message) instead of flags. (2) Rename --leaving to --leave-conversation on chat send. (3) Update usage() text. (4) Update tests. Affects: runChatSend, runChatOpen, runChatHistory, runChatHangOn, runChatShowPending.","status":"closed","priority":1,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-04T13:06:15Z","created_by":"Juan Reyero","updated_at":"2026-02-04T13:09:44Z","closed_at":"2026-02-04T13:09:44Z","close_reason":"All 5 chat subcommands refactored to positional args, --leaving renamed to --leave-conversation, usage text updated, tests pass."}
{"id":"aw-p8u","title":"Implement 'aw register' CLI command","description":"Add 'aw register --server \u003curl\u003e --email \u003cemail\u003e [--username \u003cname\u003e] [--alias \u003calias\u003e] [--human-name \u003cname\u003e]' command.\n\nCalls POST /v1/auth/register on the server, saves returned aw_sk_* as standard Account entry in config.yaml.\n\nProtocol contract:\n  Request:  { email, username?, password?, alias?, human_name? }\n  Response: { api_key, agent_id, alias, username, project_slug, project_name, server_url, verification_required }\n\nError handling: 404 (server doesn't support registration), 409 (email/username taken), 422 (missing field — prompt interactively for password if server requires it), 429 (rate limited).\n\nOn success print: 'Account created for \u003cusername\u003e. Agent \u003cusername\u003e/\u003calias\u003e is live. Verification email sent — verify within 24h.'\n\nBlocked by claweb-dfm (server-side endpoint, filed by eve). Can develop + unit test against mocked responses in parallel.\n\nDesign discussion: chat with eve 2026-02-09.","status":"closed","priority":1,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-09T14:07:03Z","created_by":"Juan Reyero","updated_at":"2026-02-09T14:20:03Z","closed_at":"2026-02-09T14:20:03Z","close_reason":"Implemented on feat/aw-register branch. register.go (types+client), cmd/aw/register.go (cobra command), 5 integration tests all passing. Blocked by server-side endpoint (claweb-dfm) for live use."}
{"id":"aw-q3q","title":"TestSendStartConversationUpgradesWhenNotExplicit doesn't verify the upgrade","description":"The test sets a 2s context timeout and Wait=DefaultWait (120s). It expects context.DeadlineExceeded to prove the wait was upgraded to 300s. But the test would produce the identical result without the upgrade — the context (2s) is shorter than DefaultWait (120s), so it would always hit DeadlineExceeded regardless.\n\nThe test proves nothing beyond 'Send waits at all', which is already tested by TestSendWithTimeout.\n\nFix: The test needs to actually observe the difference between 120s and 300s wait. Options:\n- Mock the timer or inject a clock to verify the configured timeout\n- Use a short Wait value (e.g., 1s) so the test can distinguish between 'waited 1s' (no upgrade) and 'waited longer' (upgraded to 300s)\n- Capture the wait timer value through the callback or result\n\nFiles: chat/chat_test.go (TestSendStartConversationUpgradesWhenNotExplicit)","status":"closed","priority":3,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-08T09:25:10Z","created_by":"Juan Reyero","updated_at":"2026-02-08T09:42:26Z","closed_at":"2026-02-08T09:42:26Z","close_reason":"Rewrote test to use Wait=1 so it can distinguish upgraded (300s) from non-upgraded (1s) wait. All tests pass."}
{"id":"aw-q93","title":"Make aw init --cloud work with aw_sk_ API keys","description":"Adjust resolveCloudToken in init.go to fall back to existing aw_sk_ key from config when no JWT/cloud token available. Require --alias when using aw_sk_ auth. New agent goes into same project as existing key. Server-side: Frank is making POST /api/v1/agents/bootstrap accept aw_sk_ auth.","status":"closed","priority":2,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-19T13:06:21Z","created_by":"Juan Reyero","updated_at":"2026-02-19T14:00:00Z","closed_at":"2026-02-19T14:00:00Z","close_reason":"resolveCloudToken now falls back to aw_sk_ keys from config/env when no JWT available. Early check in runInit requires --alias when using aw_sk_ auth. Updated flag help text to document the full token resolution priority."}
{"id":"aw-sb5","title":"Add after parameter to ChatStream and NetworkChatStream","description":"The SSE stream endpoint replays up to 50 historical messages on every connect. Grace is adding an optional 'after' query param (ISO timestamp) to the aweb server so clients can control replay. Client changes needed:\n\n1. ChatStream signature gains an 'after *time.Time' parameter\n2. NetworkChatStream gains the same parameter\n3. streamOpener type signature updated to include after\n4. When after is provided, append '\u0026after=\u003ciso-timestamp\u003e' to the stream URL\n5. When after is nil, no replay (server polls from now())\n\nBlocked on: Grace shipping the after param in aweb (she confirmed she's implementing it).","status":"closed","priority":2,"issue_type":"task","owner":"juan@juanreyero.com","created_at":"2026-02-08T11:52:00Z","created_by":"Juan Reyero","updated_at":"2026-02-08T12:18:11Z","closed_at":"2026-02-08T12:18:11Z","close_reason":"Implemented in commit c40f1b8: ChatStream/NetworkChatStream accept after param, Send passes sentAt timestamp, Listen passes nil, skipped replay events filtered from result.Events"}
{"id":"aw-sw6","title":"Add GetCurrentProject() client method and 'aw project' CLI command","description":"GET /v1/projects/current endpoint has no Go client method. Add GetCurrentProject() to client library and 'aw project' CLI command. Response: {project_id, slug, name}.","status":"closed","priority":3,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-04T11:23:08Z","created_by":"Juan Reyero","updated_at":"2026-02-04T11:33:26Z","closed_at":"2026-02-04T11:33:26Z","close_reason":"Closed"}
{"id":"aw-u23","title":"Fix aw chat pending to include network chats","description":"aw chat pending only calls /v1/chat/pending (local), never /v1/network/chat/pending. Cross-org network chats are invisible to agents polling with aw chat pending.","status":"closed","priority":1,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-19T21:51:14Z","created_by":"Juan Reyero","updated_at":"2026-02-19T21:51:28Z","closed_at":"2026-02-19T21:51:28Z","close_reason":"Pending now calls both ChatPending and NetworkChatPending, merges results. Context cancellation propagated, other network errors gracefully skipped."}
{"id":"aw-vin","title":"Add Email field to Account config and RegisterResponse","description":"Add Email string field to awconfig.Account struct (yaml:email). Add Email field to aweb.RegisterResponse. Store email from register response in config for use by aw verify.","status":"closed","priority":1,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-19T13:05:45Z","created_by":"Juan Reyero","updated_at":"2026-02-19T13:17:51Z","closed_at":"2026-02-19T13:17:51Z","close_reason":"Email field added to Account, Selection, and RegisterResponse with tests"}
{"id":"aw-w7a","title":"Extract shared wait loop from sendCommon and Listen to eliminate duplication","description":"Listen() in chat/chat.go:422-537 is a ~115-line copy-paste of the wait loop from sendCommon() (chat/chat.go:233-419). The extendWait closure is 100% identical. The event processing loop is nearly identical, differing only in: (1) no seenSentMessage replay-skip logic, (2) no target-filtering (returns on any message), (3) no SenderWaiting propagation.\n\nFix: Extract a shared waitForReply/waitForEvent function that accepts the differences as parameters — e.g., a message filter function, whether to skip replays, the sent message ID. Both sendCommon and Listen should call this shared function.\n\nFiles: chat/chat.go\nScope: ~115 lines of duplicated code → single shared implementation","status":"closed","priority":2,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-08T09:24:46Z","created_by":"Juan Reyero","updated_at":"2026-02-08T09:37:30Z","closed_at":"2026-02-08T09:37:30Z","close_reason":"Extracted waitForMessage function, Listen reduced from ~115 to ~15 lines. All 36 tests pass."}
{"id":"aw-xab","title":"Stop accumulating replayed SSE events in result.Events","description":"waitForMessage line 305 does result.Events = append(result.Events, chatEvent) for every SSE event including replayed historical messages. On a 35-message conversation, send-and-wait returned all 35 historical messages in the JSON response events array. This is a memory and bandwidth problem that grows with conversation size.\n\nFix: After the server-side 'after' parameter eliminates most replay, this largely goes away. But as defense in depth, consider filtering result.Events to exclude events the acceptor skipped (skip=true). Only include events that were actually processed (accepted, hang-on extensions, read receipts).","status":"closed","priority":2,"issue_type":"bug","owner":"juan@juanreyero.com","created_at":"2026-02-08T11:52:15Z","created_by":"Juan Reyero","updated_at":"2026-02-08T12:18:11Z","closed_at":"2026-02-08T12:18:11Z","close_reason":"Implemented in commit c40f1b8: ChatStream/NetworkChatStream accept after param, Send passes sentAt timestamp, Listen passes nil, skipped replay events filtered from result.Events","dependencies":[{"issue_id":"aw-xab","depends_on_id":"aw-sb5","type":"blocks","created_at":"2026-02-18T16:59:14Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"aw-y1s","title":"Skip wait when target is connected on reply","description":"When Send() sees all targets in TargetsConnected and caller didn't explicitly request waiting (no --start-conversation, no --wait), return immediately with 'delivered' status instead of opening SSE and waiting 120s. Also add Leaving to ChatSendMessageRequest and SenderWaiting to SSE event parsing.","status":"closed","priority":2,"issue_type":"feature","owner":"juan@juanreyero.com","created_at":"2026-02-07T22:38:12Z","created_by":"Juan Reyero","updated_at":"2026-02-07T22:41:54Z","closed_at":"2026-02-07T22:41:54Z","close_reason":"All 3 phases implemented: (1) Skip wait when TargetsConnected, (2) Leaving on ChatSendMessageRequest, (3) SenderWaiting on SSE events. 37 tests pass."}
